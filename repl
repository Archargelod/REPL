#!/bin/bash

COMMAND=$1

# shellcheck source=config
. config

repl_has() {
  type "${1-}" > /dev/null 2>&1
}

#######################################
# Update a line in the config file
# Globals:
#   None
# Arguments:
#   $1 - Variable to update (i.e. "LAST_RUN=") [MUST include equals sign]
#   $2 - Value to update variable with (i.e. "cpp" for LAST_RUN=)
# Returns:
#   None
#######################################
repl_update_config() {
  local SCRIPTPATH
  SCRIPTPATH="$( cd "$(dirname "$0")" || exit ; pwd -P )"

  # Currently, REPL creates a backup of `config` whenever this function is run
  sed -i.bak "s@^\($1\).*@\1\"$2\"@" "${SCRIPTPATH}/config"
}

repl_build() {
  case "$EXT" in
    js)
      local env="JavaScript"
      ;;
    cpp)
      local env="C++"
      ;;
    c)
      local env="C"
      ;;
    py)
      local env="Python"
      ;;
    rb)
      local env="Ruby"
      ;;
    rs)
      local env="Rust"
      ;;
    *)
      echo "repl: Filetype '.${EXT}' not supported"
      exit 1
      ;;
  esac

  echo "Creating ${env} repl..."

  FILEPATH="/tmp/repl.${EXT}"

  if [ ! -e "$FILEPATH" ]; then
    touch "$FILEPATH"
  fi

  repl_update_config "LAST_RUN=" "$EXT"
  repl_update_config "STATUS=" "$env"
}

repl_edit() {
  repl_build

  if repl_has "$EDITOR"; then
    eval "$EDITOR $FILEPATH"
  else
    echo "repl: editor '$EDITOR' does not exist. Check config file."
    echo "      Example:"
    echo "          EDITOR=\"vim\""
    echo "      or"
    echo "          EDITOR=\"/usr/bin/vim\""
    exit 1
  fi
}

repl_status() {
  if [ -z $LAST_RUN ]; then
    echo "repl: No current repl"
  else
    echo "repl status: currently in a $STATUS repl"
  fi
}

repl_run() {
  . repl_modules

  case "$LAST_RUN" in
    c)
      repl_c
      ;;
    cpp)
      repl_cpp
      ;;
    js)
      repl_javascript
      ;;
    py)
      repl_python
      ;;
    rb)
      repl_ruby
      ;;
    rs)
      repl_rust
      ;;
    "")
      echo "repl: could not detect existing repl"
      echo "      create a repl first: I.E. 'repl js'"
      exit 1
  esac
}

main() {
  case "$COMMAND" in
    "")
      echo "repl: missing operand"
      echo "      Try 'repl js'"
      exit 1
      ;;
    run)
      repl_run
      ;;
    status)
      repl_status
      ;;
    *)
      EXT="$COMMAND"
      repl_edit
      ;;
  esac
}

main

exit 0
